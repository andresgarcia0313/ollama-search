#!/usr/bin/env bash
# ollama-cli: search/inspect Ollama Library from the terminal.
# Requires: curl, grep, awk, sed
set -euo pipefail

HOST=${OLLAMA_LIBRARY_HOST:-https://ollama.com}
LIB="$HOST/library"
SEARCH_URL="$HOST/search"

# Defaults
LANG_CHOICE=${OLLAMA_SEARCH_LANG:-en}
LIMIT=50

need() { command -v "$1" >/dev/null 2>&1 || { echo "Missing '$1'. Please install it."; exit 1; }; }
need curl; need grep; need awk; need sed

# --- i18n (minimal) ---
msg() {
  local key="$1"
  case "$LANG_CHOICE" in
    es)
      case "$key" in
        USAGE) cat <<'EOF'
Uso:
  ollama-cli search <texto|modelo> [--limit N] [--lang en|es]
     - Busca modelos en la librería web y muestra líneas "modelo:tag".
     - Si <texto> es un nombre de modelo exacto, lista todas sus tags.

  ollama-cli exists <modelo>
     - Devuelve "yes"/"no" si existe en la librería remota.

  ollama-cli tags <modelo>
     - Lista sólo las tags de ese modelo (una por línea).

  ollama-cli pull <modelo[:tag]>
     - Hace "ollama pull" si existe y no está instalado.

  ollama-cli installed
     - Muestra modelos locales (equivale a "ollama list").

Opciones:
  --limit N      Limita cuántos modelos procesa en "search" (por defecto 50)
  --lang en|es   Idioma de mensajes (por defecto: en; también OLLAMA_SEARCH_LANG)
  -h, --help     Muestra esta ayuda
Notas:
  - No hay endpoint oficial para listar el catálogo remoto; se usa HTML de /search y /library/<modelo>.
EOF
        ;;
        NOT_FOUND) echo "No encontrado en la librería:" ;;
        DOWNLOADING) echo "Descargando" ;;
        INSTALLED) echo "Ya instalado:" ;;
        NEED_ARG) echo "Falta argumento." ;;
      esac
      ;;
    *) # en
      case "$key" in
        USAGE) cat <<'EOF'
Usage:
  ollama-cli search <text|model> [--limit N] [--lang en|es]
     - Searches the web library and prints "model:tag" lines.
     - If <text> is an exact model name, prints all its tags.

  ollama-cli exists <model>
     - Prints "yes"/"no" if the model exists in the remote library.

  ollama-cli tags <model>
     - Prints tags of the model (one per line).

  ollama-cli pull <model[:tag]>
     - Runs "ollama pull" if it exists and isn't installed.

  ollama-cli installed
     - Shows local models (same as "ollama list").

Options:
  --limit N      Limit how many models are processed by "search" (default 50)
  --lang en|es   Message language (default: en; also OLLAMA_SEARCH_LANG)
  -h, --help     Show this help
Notes:
  - There is no official endpoint to list the remote catalog; this scrapes /search and /library/<model>.
EOF
        ;;
        NOT_FOUND) echo "Not found in library:" ;;
        DOWNLOADING) echo "Downloading" ;;
        INSTALLED) echo "Already installed:" ;;
        NEED_ARG) echo "Missing argument." ;;
      esac
      ;;
  esac
}

usage() { msg USAGE; }

# --- helpers ---
parse_models() {
  # Extract /library/<name> from HTML and normalize
  grep -oE '/library/[a-zA-Z0-9._:-]+' \
  | sed 's#/library/##' \
  | sed 's#:$##' \
  | sort -u
}

urlencode() { local s="${1}"; python3 - <<EOF 2>/dev/null || echo "${s// /%20}"
import urllib.parse,sys;print(urllib.parse.quote(sys.argv[1]))
EOF
}

exists_model() {
  local m="$1"
  local code
  code=$(curl -s -o /dev/null -w '%{http_code}' "$LIB/$m")
  [[ "$code" == "200" ]]
}

list_tags() {
  local m="$1"
  # Extract occurrences like "<model>:<tag>" from the model page
  curl -fsSL "$LIB/$m" \
  | grep -oE "${m}:[a-zA-Z0-9._-]+" \
  | awk -F: '{print $2}' \
  | sort -u
}

search_models() {
  local q="$1"
  local enc; enc=$(urlencode "$q")
  if html=$(curl -fsSL "$SEARCH_URL?q=$enc"); then
    echo "$html" | parse_models
  else
    # Fallback: list library and fuzzy-filter
    curl -fsSL "$LIB" | parse_models | grep -i "$q" || true
  fi
}

print_model_tags_lines() {
  # Prints "model:tag" lines; if no tags found, print "model:latest"
  local m="$1"
  local found=0
  while IFS= read -r tag; do
    [[ -z "$tag" ]] && continue
    echo "${m}:${tag}"
    found=1
  done < <(list_tags "$m" || true)

  if [[ "$found" -eq 0 ]]; then
    # As a fallback, at least print the model name
    echo "${m}:latest"
  fi
}

# --- arg parsing (simple) ---
ARGS=()
while [[ "${1:-}" != "" ]]; do
  case "$1" in
    --lang) LANG_CHOICE="${2:-en}"; shift 2;;
    --lang=*) LANG_CHOICE="${1#*=}"; shift;;
    --limit) LIMIT="${2:-50}"; shift 2;;
    --limit=*) LIMIT="${1#*=}"; shift;;
    -h|--help|help) usage; exit 0;;
    *) ARGS+=("$1"); shift;;
  esac
done
set -- "${ARGS[@]:-}"

cmd="${1:-}"
arg="${2:-}"

case "$cmd" in
  search)
    [[ -z "$arg" ]] && { msg NEED_ARG; echo; usage; exit 1; }

    # If it's an exact model page, just print its tags (model:tag)
    if exists_model "$arg"; then
      print_model_tags_lines "$arg"
      exit 0
    fi

    # Otherwise, search and expand tags for each model (up to LIMIT)
    count=0
    while IFS= read -r m; do
      [[ -z "$m" ]] && continue
      print_model_tags_lines "$m"
      count=$((count+1))
      [[ "$count" -ge "$LIMIT" ]] && break
    done < <(search_models "$arg")
    ;;
  tags)
    [[ -z "$arg" ]] && { msg NEED_ARG; exit 1; }
    exists_model "$arg" || { msg NOT_FOUND; echo "  $LIB/$arg"; exit 2; }
    list_tags "$arg"
    ;;
  exists)
    [[ -z "$arg" ]] && { msg NEED_ARG; exit 1; }
    if exists_model "$arg"; then echo "yes"; else echo "no"; fi
    ;;
  pull)
    [[ -z "$arg" ]] && { msg NEED_ARG; exit 1; }
    if command -v ollama >/dev/null 2>&1; then
      if ollama list 2>/dev/null | awk '{print $1}' | grep -qx "${arg}"; then
        msg INSTALLED; echo " ${arg}"; exit 0
      fi
    fi
    base="${arg%%:*}"
    exists_model "$base" || { msg NOT_FOUND; echo "  $LIB/$base"; exit 2; }
    msg DOWNLOADING; echo " ${arg}..."
    exec ollama pull "${arg}"
    ;;
  installed)
    exec ollama list
    ;;
  ""|-h|--help|help)
    usage
    ;;
  *)
    usage; exit 1;;
esac
